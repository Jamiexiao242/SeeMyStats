{% extends 'base.html' %}

{% block title %}HealthWeb - Processing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title mb-0">Processing Your Data</h2>
            </div>
            <div class="card-body">
                <p class="lead" id="status-message">Preparing to parse export.xml...</p>
                <div class="progress mb-3" style="height: 24px;">
                    <div
                        id="status-bar"
                        class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar"
                        style="width: 5%;">
                        5%
                    </div>
                </div>
                <p class="text-muted">You can keep this page open while we finish parsing.</p>
                <div id="status-actions" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const uploadId = "{{ upload_id }}";
    const statusUrl = "{{ url_for('upload.status') }}?upload_id=" + encodeURIComponent(uploadId);
    const dashboardUrl = "{{ url_for('dashboard.index') }}";
    const uploadUrl = "{{ url_for('upload.upload_file') }}";

    function setProgress(progress) {
        const bar = document.getElementById('status-bar');
        const clamped = Math.max(0, Math.min(100, progress));
        bar.style.width = clamped + '%';
        bar.textContent = clamped + '%';
    }

    function setMessage(message) {
        document.getElementById('status-message').textContent = message || '';
    }

    function showErrorAction(message) {
        const actions = document.getElementById('status-actions');
        actions.innerHTML = `
            <div class="alert alert-danger">${message}</div>
            <a href="${uploadUrl}" class="btn btn-primary">Try Again</a>
        `;
    }

    function showSuccessAction(message) {
        const actions = document.getElementById('status-actions');
        actions.innerHTML = `
            <div class="alert alert-success">${message}</div>
            <a href="${dashboardUrl}" class="btn btn-success">Go to Dashboard</a>
        `;
    }

    function updateStatus() {
        fetch(statusUrl)
            .then(response => response.json())
            .then(data => {
                setMessage(data.message || 'Working...');
                setProgress(data.progress || 0);

                if (data.status === 'done' || (data.progress || 0) >= 100) {
                    showSuccessAction(data.message || 'Parsing complete.');
                    clearInterval(pollTimer);
                    setTimeout(() => {
                        window.location.replace(dashboardUrl);
                    }, 500);
                } else if (data.status === 'error' || data.status === 'unknown') {
                    const bar = document.getElementById('status-bar');
                    bar.classList.remove('progress-bar-animated');
                    bar.classList.remove('progress-bar-striped');
                    showErrorAction(data.message || 'Parsing failed.');
                    clearInterval(pollTimer);
                }
            })
            .catch(() => {
                setMessage('Waiting for status...');
            });
    }

    updateStatus();
    const pollTimer = setInterval(updateStatus, 2000);
</script>
{% endblock %}
